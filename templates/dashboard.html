<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - CropSight AI</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <!-- Navigation Bar (Sticky) -->
  <nav class="navbar">
    <h3>CropSight AI</h3>
    <a href="/" onclick="event.preventDefault(); confirmLogout();">Logout</a>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <h1>Rice Leaf Disease Detection</h1>
    <p>Upload a leaf image to detect diseases like Brown Spot, Hispa, or Leaf Blast.</p>

    <!-- Instructions Button -->
    <button onclick="openInstructions('en')" class="btn-primary" style="background-color:#1976d2; margin-bottom:10px;">
      ЁЯУШ How to Use
    </button>

    <!-- Language Buttons -->
    <div style="margin-bottom: 20px;">
      <button onclick="openInstructions('si')" class="lang-btn">р╖Гр╖Тр╢Вр╖Др╢╜</button>
      <button onclick="openInstructions('ta')" class="lang-btn">родрооро┐ро┤рпН</button>
    </div>

    <!-- Image Upload -->
    <input type="file" id="imageInput" accept="image/*" class="file-input" />
    <button onclick="analyzeImage()" class="btn-primary">Analyze Leaf</button>

    <!-- Prediction Result -->
    <div id="result" class="result-box"></div>

    <!-- Prediction History -->
    <div id="historySection" class="history-box">
      <h3>Recent Predictions</h3>
      <button onclick="clearHistory()" class="btn-primary" style="background-color:#d32f2f;">ЁЯЧСя╕П Clear History</button>
      <ul id="historyList" style="list-style: none; padding: 0; margin-top: 10px;"></ul>
    </div>
  </div>

  <!-- Instructions Modal -->
  <div id="instructionsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">How to Use CropSight AI</h3>
        <span class="close-btn" onclick="closeInstructions()">&times;</span>
      </div>
      <div id="instructionsBody">
        <!-- Dynamically injected -->
      </div>
      <button onclick="closeInstructions()" class="btn-close">Got It</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Language Instructions
    const instructions = {
      en: {
        title: "How to Use CropSight AI",
        steps: `
          <ol class="instruction-list">
            <li>Click on <strong>"Choose File"</strong> and select a clear photo of a rice leaf.</li>
            <li>Make sure the leaf fills the image and is in good light (not too dark or blurry).</li>
            <li>Click the <strong>"Analyze Leaf"</strong> button.</li>
            <li>Wait a few seconds тАФ the system will check for diseases.</li>
            <li>View the result: It will show the disease name and confidence level.</li>
          </ol>
          <p><strong>Tip:</strong> Use a clean background and avoid shadows for best results.</p>
        `
      },
      si: {
        title: "CropSight AI р╢╖р╖Пр╖Ар╖Тр╢нр╖П р╢Ър╢╗р╢▒ р╢Жр╢Ър╖Пр╢╗р╢║",
        steps: `
          <ol class="instruction-list">
            <li><strong>"р╖Жр╢║р╖Тр╢╜р╢║ р╢нр╖Эр╢╗р╢▒р╖Кр╢▒"</strong> р╢Фр╢╢р╢▒р╖Кр╢▒ р╖Гр╖Д р╢┤р╖Рр╢мр╖Т р╢Ър╖Ьр╖Ер╢║р╢Ъ р╢┤р╖Рр╖Др╖Рр╢пр╖Тр╢╜р╖Т р╢бр╖Пр╢║р╖Пр╢╗р╖Цр╢┤р╢║р╢Ър╖К р╢нр╖Эр╢╗р╢▒р╖Кр╢▒.</li>
            <li>р╢Ър╖Ьр╖Ер╢║ р╢бр╖Пр╢║р╖Пр╢╗р╖Цр╢┤р╢║ р╢┤р╖Фр╢╗р╖П р╖Ар╖Рр╢зр╖Ур╢╕ р╖Гр╖Д р╖Др╖Ьр╢│ р╢Жр╢╜р╖Эр╢Ър╢║р╢Ър╖К (р╢Ер╢│р╖Фр╢╗р╖Ф р╖Др╖Э р╢пр╖Фр╖Вр╖Кр╢Ър╢╗ р╢▒р╖Ьр╖Ар╖Ур╢╕) р╢нр╖Др╖Ар╖Фр╢╗р╖Ф р╢Ър╢╗р╢▒р╖Кр╢▒.</li>
            <li><strong>"р╢Ър╖Ьр╖Ер╢║ р╖Ар╖Тр╖Бр╖Кр╢╜р╖Ър╖Вр╢лр╢║ р╢Ър╢╗р╢▒р╖Кр╢▒"</strong> р╢╢р╖Ьр╢нр╖Кр╢нр╢╕ р╢Фр╢╢р╢▒р╖Кр╢▒.</li>
            <li>р╢нр╢нр╖Кр╢┤р╢╗ р╢Ър╖Тр╖Др╖Тр╢┤р╢║р╢Ър╖К р╢╗р╖Рр╢│р╖У р╖Гр╖Тр╢зр╖Тр╢▒р╖Кр╢▒ тАФ р╢┤р╢пр╖Кр╢░р╢нр╖Тр╢║ р╢╗р╖Эр╢Ь р╖Гр╢│р╖Др╖П р╢┤р╢╗р╖Ур╢Ър╖Кр╖Вр╖П р╢Ър╢╗р╢║р╖Т.</li>
            <li>р╢┤р╖КтАНр╢╗р╢нр╖Тр╢╡р╢╜р╢║ р╢╢р╢╜р╢▒р╖Кр╢▒: р╢╗р╖Эр╢Ьр╢║р╖Ъ р╢▒р╖Пр╢╕р╢║ р╖Гр╖Д р╖Ар╖Тр╖Бр╖Кр╖Ар╖Пр╖Гр╢║ р╢╕р╢зр╖Кр╢зр╢╕ р╢┤р╖Щр╢▒р╖Кр╖Ар╢║р╖Т.</li>
          </ol>
          <p><strong>р╢Лр╢┤р╢пр╖Щр╖Гр╖К:</strong> р╖Др╖Ьр╢│р╢╕ р╢┤р╖КтАНр╢╗р╢нр╖Тр╢╡р╢╜ р╖Гр╢│р╖Др╖П р╢┤р╖Рр╖Др╖Рр╢пр╖Тр╢╜р╖Т р╢┤р╖Гр╖Фр╢╢р╖Тр╢╕р╢Ър╖К р╢╖р╖Пр╖Ар╖Тр╢нр╖П р╢Ър╢╗р╢▒р╖Кр╢▒.</p>
        `
      },
      ta: {
        title: "CropSight AI-роР рокропройрпНрокроЯрпБродрпНродрпБро╡родрпБ роОрокрпНрокроЯро┐",
        steps: `
          <ol class="instruction-list">
            <li><strong>"роХрпЛрокрпНрокрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН"</strong> роРроХрпН роХро┐ро│ро┐роХрпН роЪрпЖропрпНродрпБ, роирпЖро▓рпН роЗро▓рпИропро┐ройрпН родрпЖро│ро┐ро╡ро╛рой рокрпБроХрпИрокрпНрокроЯродрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН.</li>
            <li>роЗро▓рпИ рокроЯродрпНродрпИ роиро┐ро░рокрпНрокро┐, роиро▓рпНро▓ роТро│ро┐ропро┐ро▓рпН (рооро┐роХро╡рпБроорпН роЗро░рпБроЯрпНроЯро╛роХро╡рпЛ роЕро▓рпНро▓родрпБ роороЩрпНроХро▓ро╛роХро╡рпЛ роЗро▓рпНро▓ро╛рооро▓рпН) роЗро░рпБрокрпНрокродрпИ роЙро▒рпБродро┐ роЪрпЖропрпНропро╡рпБроорпН.</li>
            <li><strong>"роЗро▓рпИропрпИрокрпН рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роЪрпЖропрпНроХ"</strong> рокрпКродрпНродро╛ройрпИроХрпН роХро┐ро│ро┐роХрпН роЪрпЖропрпНроХ.</li>
            <li>роЪро┐ро▓ ро╡ро┐ройро╛роЯро┐роХро│рпН роХро╛родрпНродро┐ро░рпБроЩрпНроХро│рпН тАФ роирпЛропрпНроХро│рпБроХрпНроХро╛роХ роЕроорпИрокрпНрокрпБ роЪро░ро┐рокро╛ро░рпНроХрпНроХрпБроорпН.</li>
            <li>роорпБроЯро┐ро╡рпИрокрпН рокро╛ро░рпБроЩрпНроХро│рпН: роирпЛропро┐ройрпН рокрпЖропро░рпИропрпБроорпН, роироорпНрокро┐роХрпНроХрпИ роЕро│ро╡рпИропрпБроорпН роХро╛роЯрпНроЯрпБроорпН.</li>
          </ol>
          <p><strong>роХрпБро▒ро┐рокрпНрокрпБ:</strong> роЪро┐ро▒роирпНрод роорпБроЯро┐ро╡рпБроХро│рпБроХрпНроХрпБ родрпЖро│ро┐ро╡ро╛рой рокро┐ройрпНройрогро┐ропрпИрокрпН рокропройрпНрокроЯрпБродрпНродро╡рпБроорпН.</p>
        `
      }
    };

    // Open Instructions
    function openInstructions(lang = 'en') {
      const modal = document.getElementById('instructionsModal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('instructionsBody');
      title.innerText = instructions[lang].title;
      body.innerHTML = instructions[lang].steps;
      modal.style.display = 'flex';
    }

    // Close Instructions
    function closeInstructions() {
      document.getElementById('instructionsModal').style.display = 'none';
    }

    // Analyze Image
    function analyzeImage() {
      const fileInput = document.getElementById('imageInput');
      const resultDiv = document.getElementById('result');
      const file = fileInput.files[0];
      if (!file) {
        resultDiv.innerHTML = '<p style="color:red;">Please select an image!</p>';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      resultDiv.innerHTML = '<p>Analyzing тП│</p>';

      fetch('/predict', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          resultDiv.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
        } else {
          resultDiv.innerHTML = `
            <h3>Disease: <strong>${data.class}</strong></h3>
            <p><strong>Confidence:</strong> ${data.confidence}%</p>
          `;
          loadHistory(); // Refresh history after prediction
        }
      })
      .catch(err => {
        resultDiv.innerHTML = `<p style="color:red;">Server error. Try again.</p>`;
      });
    }

    // Load History with Correct Sri Lankan Time
    function loadHistory() {
      fetch('/history')
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById('historyList');
          list.innerHTML = '';
          if (data.length === 0) {
            list.innerHTML = '<li style="color:#666;">No history yet</li>';
            return;
          }
          data.forEach(item => {
            const li = document.createElement('li');

            // Parse the timestamp as Sri Lankan time
            const [datePart, timePart] = item.timestamp.split(' ');
            const [year, month, day] = datePart.split('-');
            const [hour, minute, second] = timePart.split(':');

            // Create Date object assuming the time is already in Asia/Colombo
            const localTime = new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}+05:30`);

            const options = {
              timeZone: 'Asia/Colombo',
              year: 'numeric',
              month: 'short',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            };
            const formattedTime = localTime.toLocaleString('en-LK', options);

            li.innerHTML = `
              <div style="background:#f0f8f0; padding:10px; margin:5px 0; border-radius:5px; text-align:left;">
                <strong>${item.disease}</strong> (${item.confidence}%)
                <br>
                <small>${formattedTime}</small>
              </div>
            `;
            list.appendChild(li);
          });
        })
        .catch(err => {
          console.error("Failed to load history:", err);
          const list = document.getElementById('historyList');
          list.innerHTML = '<li style="color:red;">Failed to load history</li>';
        });
    }

    // Clear History
    function clearHistory() {
      if (!confirm("Are you sure you want to clear your history?")) return;
      fetch('/clear_history', { method: 'POST' })
        .then(res => res.json())
        .then(() => loadHistory())
        .catch(() => alert("Failed to clear history."));
    }

    // Confirm Logout
    function confirmLogout() {
      if (confirm("Are you sure you want to log out?")) {
        window.location.href = '/';
      }
    }

    // Load history on page load
    window.onload = loadHistory;
  </script>
</body>
</html>